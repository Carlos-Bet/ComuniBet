<script type="module" defer>
  // Import the functions you need from the SDKs you need
  // *** TODAS LAS IMPORTACIONES DE FIREBASE SE ACTUALIZAN A LA VERSIÓN 12.0.0 ***
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  // Importamos 'setDoc' y 'doc' aquí
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, where, arrayUnion, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js"; // Descomentado si quieres usar Analytics

  // Your web app's Firebase configuration (ESTA ES LA CONFIGURACIÓN QUE ME PROPORCIONASTE)
  const firebaseConfig = {
    apiKey: "AIzaSyAs19oiYivfPYSCl_-xcOFeBQMziZSeBn0", // TU API KEY INTEGRADA AQUÍ
    authDomain: "comunibetstudio.firebaseapp.com",
    projectId: "comunibetstudio",
    storageBucket: "comunibetstudio.firebasestorage.app",
    messagingSenderId: "980411984792",
    appId: "1:980411984792:web:c7ab103a9efe8e121e99ed",
    measurementId: "G-P6EJLZRTVV"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const analytics = getAnalytics(app); // Inicializa Analytics

  // ** Variables globales para el estado del usuario y el perfil visitado **
  window.usuarioActual = null; // Nombre de usuario del que está logueado
  window.usuarioAuthId = null; // UID del que está logueado
  window.perfilVisitadoUid = null; // UID del perfil que se está viendo actualmente
  window.likes = new Map();

  // Función auxiliar para obtener el nombre de usuario por UID
  async function getUserNameByUid(uid) {
      if (!uid) return null;
      const q = query(collection(db, "usuarios"), where("uid", "==", uid));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
          return querySnapshot.docs[0].data().userName;
      }
      return null;
  }
  window.getUserNameByUid = getUserNameByUid;

  // Función auxiliar para obtener el UID por nombre de usuario
  async function getUidByUserName(userName) {
      if (!userName) return null;
      const q = query(collection(db, "usuarios"), where("userName", "==", userName));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) { // Asegúrate de devolver el UID si se encuentra
          return querySnapshot.docs[0].data().uid;
      }
      return null;
  }
  window.getUidByUserName = getUidByUserName;

  // Función auxiliar para verificar si un nombre de usuario existe
  async function checkIfUserNameExists(username) {
      const q = query(collection(db, "usuarios"), where("userName", "==", username));
      const querySnapshot = await getDocs(q);
      return !querySnapshot.empty;
  }
  window.checkIfUserNameExists = checkIfUserNameExists;

  // Nueva función para cargar los datos del perfil de un UID específico
  async function cargarDatosPerfilDeFirestore(uid) {
      if (!uid) return { userName: '', descripcion: '', seguidores: [], siguiendo: [] };
      const q = query(collection(db, "usuarios"), where("uid", "==", uid));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
          const userData = querySnapshot.docs[0].data();
          return {
              userName: userData.userName,
              descripcion: userData.descripcion || '',
              seguidores: userData.seguidores || [],
              siguiendo: userData.siguiendo || []
          };
      }
      return { userName: '', descripcion: '', seguidores: [], siguiendo: [] };
  }
  // ¡¡¡CORRECCIÓN AQUÍ!!! Nombre de función correcto
  window.cargarDatosPerfilDeFirestore = cargarDatosPerfilDeFirestore;

  // ** Funciones de UI y Lógica (usan las variables globales) **
  function toggleModo() {
    document.body.classList.toggle('light');
  }

  function mostrarSeccion(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    // Asegurarse de que las secciones de registro/login se oculten si no son la activa
    if (id !== 'login' && id !== 'registro') {
        document.getElementById('registro').style.display = 'none';
        document.getElementById('login').style.display = 'none';
    }
  }

  function mostrarLoginScreen() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('login').classList.add('active');
    document.getElementById('registro').style.display = 'none';
    document.getElementById('login').style.display = 'block';
  }

  function mostrarRegistroScreen() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('registro').classList.add('active');
    document.getElementById('login').style.display = 'none';
    document.getElementById('registro').style.display = 'block';
  }

  // Modificamos verPerfil para cargar el perfil correcto y controlar la edición
  async function verPerfil(nombre) {
    const uidDelPerfil = await getUidByUserName(nombre);

    if (!uidDelPerfil) {
      alert(`No se encontró el perfil de ${nombre}.`);
      return;
    }

    window.perfilVisitadoUid = uidDelPerfil; // Establecer el UID del perfil que se está viendo

    const datosPerfil = await cargarDatosPerfilDeFirestore(uidDelPerfil);

    document.getElementById('nombrePerfil').textContent = datosPerfil.userName;
    document.getElementById('descripcionPerfil').value = datosPerfil.descripcion;
    document.getElementById('contadorSeguidores').textContent = datosPerfil.seguidores.length;

    const btnSeguir = document.getElementById('btnSeguir');
    const descripcionInput = document.getElementById('descripcionPerfil');
    const guardarDescripcionBtn = document.getElementById('guardarDescripcionBtn');


    if (uidDelPerfil === window.usuarioAuthId) {
      // Es nuestro propio perfil
      btnSeguir.style.display = 'none'; // No se puede seguir a uno mismo
      descripcionInput.readOnly = false; // Podemos editar nuestra descripción
      guardarDescripcionBtn.style.display = 'inline-block'; // Mostrar botón Guardar
    } else {
      // Es el perfil de otra persona
      btnSeguir.style.display = 'inline-block'; // Mostrar botón de seguir
      descripcionInput.readOnly = true; // NO podemos editar su descripción (solo lectura)
      guardarDescripcionBtn.style.display = 'none'; // Ocultar botón Guardar para perfiles ajenos

      // Verificar si ya seguimos a esta persona
      if (window.usuarioAuthId && datosPerfil.seguidores.includes(window.usuarioAuthId)) {
        btnSeguir.textContent = "Siguiendo";
      } else {
        btnSeguir.textContent = "Seguir";
      }
    }

    mostrarSeccion('perfil');
  }

  function mostrarNotificaciones() {
    alert("No tienes nuevas notificaciones.");
  }

  function buscar(valor) {
    alert("Buscando: " + valor);
  }

  async function guardarDescripcion() {
    if (!window.usuarioAuthId || window.perfilVisitadoUid !== window.usuarioAuthId) {
      alert("Solo puedes editar tu propia descripción.");
      return;
    }

    const nuevaDescripcion = document.getElementById('descripcionPerfil').value;
    try {
      const q = query(collection(db, "usuarios"), where("uid", "==", window.usuarioAuthId));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
          const userDocRef = querySnapshot.docs[0].ref;
          await updateDoc(userDocRef, {
              descripcion: nuevaDescripcion
          });
          alert("Descripción guardada.");
      } else {
          alert("Error: No se encontró tu perfil para guardar la descripción.");
      }
    } catch (e) {
      console.error("Error al guardar descripción:", e);
      alert("Hubo un error al guardar la descripción.");
    }
  }

  async function toggleSeguir() {
    if (!window.usuarioAuthId) {
      alert("Debes iniciar sesión para seguir a otros usuarios.");
      return;
    }
    if (window.perfilVisitadoUid === window.usuarioAuthId) {
      alert("No puedes seguirte a ti mismo.");
      return;
    }
    if (!window.perfilVisitadoUid) {
      alert("No hay un perfil válido seleccionado para seguir.");
      return;
    }

    const btn = document.getElementById("btnSeguir");
    const contadorSeguidores = document.getElementById("contadorSeguidores");

    try {
      // Obtenemos la referencia al documento del usuario actual
      const miUsuarioQuery = query(collection(db, "usuarios"), where("uid", "==", window.usuarioAuthId));
      const miUsuarioSnapshot = await getDocs(miUsuarioQuery);
      if (miUsuarioSnapshot.empty) {
          console.error("Documento de usuario actual no encontrado en Firestore.");
          alert("Error: Tu perfil no se encontró para actualizar el seguimiento.");
          return;
      }
      const miUsuarioDocRef = miUsuarioSnapshot.docs[0].ref;

      // Obtenemos la referencia al documento del usuario a seguir/dejar de seguir
      const otroUsuarioQuery = query(collection(db, "usuarios"), where("uid", "==", window.perfilVisitadoUid));
      const otroUsuarioSnapshot = await getDocs(otroUsuarioQuery);
      if (otroUsuarioSnapshot.empty) {
          console.error("Documento del otro usuario no encontrado en Firestore.");
          alert("Error: El perfil que intentas seguir no se encontró.");
          return;
      }
      const otroUsuarioDocRef = otroUsuarioSnapshot.docs[0].ref;

      if (btn.textContent === "Seguir") {
        // Si estaba en "Seguir", ahora lo va a seguir
        await updateDoc(miUsuarioDocRef, {
          siguiendo: arrayUnion(window.perfilVisitadoUid)
        });
        await updateDoc(otroUsuarioDocRef, {
          seguidores: arrayUnion(window.usuarioAuthId)
        });
        btn.textContent = "Siguiendo";
        contadorSeguidores.textContent = parseInt(contadorSeguidores.textContent) + 1;
      } else {
        // Si estaba en "Siguiendo", ahora lo va a dejar de seguir
        await updateDoc(miUsuarioDocRef, {
          siguiendo: arrayRemove(window.perfilVisitadoUid)
        });
        await updateDoc(otroUsuarioDocRef, {
          seguidores: arrayRemove(window.usuarioAuthId)
        });
        btn.textContent = "Seguir";
        contadorSeguidores.textContent = parseInt(contadorSeguidores.textContent) - 1;
      }
    } catch (e) {
      console.error("Error al seguir/dejar de seguir:", e);
      // Aquí puedes dar un mensaje más específico si el error.code es relevante
      alert("Hubo un error al actualizar la relación de seguimiento. Revisa la consola para más detalles.");
    }
  }


  // ** LÓGICA DE AUTENTICACIÓN Y ESTADO DE USUARIO **

  // Escucha cambios en el estado de autenticación de Firebase
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      console.log("onAuthStateChanged: Usuario autenticado. UID:", user.uid);
      window.usuarioAuthId = user.uid; // Actualiza la variable global
      const userName = await getUserNameByUid(user.uid);

      if (userName) {
        console.log("onAuthStateChanged: Nombre de usuario encontrado:", userName);
        window.usuarioActual = userName; // Actualiza la variable global
        
        // Establecer el perfil visitado como el propio al iniciar sesión o cargar la página
        window.perfilVisitadoUid = user.uid; 
        
        mostrarSeccion('foro'); // Muestra el foro por defecto al iniciar sesión
        document.getElementById('main-menu').style.display = 'flex';
        document.getElementById('registro').style.display = 'none';
        document.getElementById('login').style.display = 'none';
        
        // Cargar los datos del perfil del usuario logueado para "Mi Perfil"
        const myProfileData = await cargarDatosPerfilDeFirestore(user.uid);
        document.getElementById('nombrePerfil').textContent = myProfileData.userName; // Asegurar que el nombre en el perfil sea el correcto
        document.getElementById('descripcionPerfil').value = myProfileData.descripcion;
        document.getElementById('contadorSeguidores').textContent = myProfileData.seguidores.length;
        
        // Configuración específica para el propio perfil (editable)
        document.getElementById('btnSeguir').style.display = 'none'; // No mostrar seguir en tu propio perfil
        document.getElementById('descripcionPerfil').readOnly = false; // Tu descripción es editable
        document.getElementById('guardarDescripcionBtn').style.display = 'inline-block'; // Mostrar botón Guardar
        
        cargarPublicaciones(); // Carga las publicaciones
      } else {
        console.warn("onAuthStateChanged: Usuario autenticado pero nombre de usuario NO ENCONTRADO en Firestore.");
        alert("Error: Nombre de usuario no encontrado en la base de datos. Por favor, asegúrate de haberte registrado correctamente o contacta al soporte.");
        signOut(auth); // Desconectar si no se encuentra el nombre de usuario
      }
    } else {
      console.log("onAuthStateChanged: No hay usuario autenticado.");
      window.usuarioActual = null;
      window.usuarioAuthId = null;
      window.perfilVisitadoUid = null; // Reiniciar perfil visitado
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('login').classList.add('active'); // Por defecto, muestra el login
      document.getElementById('main-menu').style.display = 'none';
      document.getElementById('registro').style.display = 'block'; // Asegura que el registro sea visible si está activo
      document.getElementById('login').style.display = 'block'; // Asegura que el login sea visible si está activo

      if (document.getElementById('registro').classList.contains('active')) {
          document.getElementById('login').style.display = 'none';
      } else {
          document.getElementById('login').style.display = 'none';
      }
    }
  });

  async function registrarse() {
      const email = document.getElementById('nuevoEmail').value;
      const contrasena = document.getElementById('nuevaContrasena').value;
      const username = document.getElementById('nuevoNombreUsuario').value;

      if (!email || !contrasena || !username) {
          alert("Por favor, completa todos los campos (email, contraseña, nombre de usuario).");
          return;
      }

      const usernameExists = await checkIfUserNameExists(username);
      if (usernameExists) {
          alert("El nombre de usuario '" + username + "' ya está en uso. Por favor, elige otro.");
          return;
      }

      try {
          console.log("DEBUG: Intentando crear usuario con email:", email);
          const userCredential = await createUserWithEmailAndPassword(auth, email, contrasena);
          const user = userCredential.user;

          console.log("DEBUG: Usuario autenticado exitosamente en Firebase Auth:");
          console.log("DEBUG: user.uid:", user.uid);
          console.log("DEBUG: user.email:", user.email);
          // window.usuarioAuthId se actualizará en onAuthStateChanged
          
          // No necesitamos un setTimeout aquí si el user object ya está disponible.
          // La regla de Firestore es la que debe ser precisa.

          // *** CAMBIO CRÍTICO AQUÍ: Usar doc() y setDoc() para establecer el UID como ID del documento ***
          // En lugar de addDoc, que genera un ID automático, usamos setDoc con el UID como ID.
          await setDoc(doc(db, "usuarios", user.uid), { // user.uid será el ID del documento
              uid: user.uid,
              userName: username,
              email: email,
              createdAt: Date.now(),
              descripcion: '',
              seguidores: [],
              siguiendo: []
          });
          console.log("DEBUG: Documento de usuario añadido a Firestore exitosamente con UID como ID.");


          alert("Cuenta creada. Por favor, inicia sesión.");
          document.getElementById('nuevoEmail').value = '';
          document.getElementById('nuevaContrasena').value = '';
          document.getElementById('nuevoNombreUsuario').value = '';
          mostrarLoginScreen();
      } catch (error) {
          const errorMessage = error.message;
          console.error("Error de registro (Firebase Auth o Firestore):", error);
          if (error.code === 'auth/email-already-in-use') {
              alert("El correo electrónico ya está en uso. Por favor, usa otro o inicia sesión.");
          } else if (error.code === 'auth/invalid-email') {
              alert("El formato del correo electrónico es inválido.");
          } else if (error.code === 'auth/weak-password') {
              alert("La contraseña es demasiado débil (debe tener al menos 6 caracteres).");
          } else if (error.code === 'auth/operation-not-allowed') {
              alert("El registro con correo/contraseña no está habilitado en tu proyecto Firebase. Por favor, contacta al administrador.");
          }
          else {
              alert(`Error al registrar: ${errorMessage}`);
          }
      }
  }

  async function iniciarSesion() {
    const email = document.getElementById('usuario').value;
    const contrasena = document.getElementById('contrasena').value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, contrasena);
      const user = userCredential.user;
      console.log("iniciarSesion: Inicio de sesión exitoso en Firebase Auth.");

      document.getElementById('usuario').value = '';
      document.getElementById('contrasena').value = '';

      // Una vez que el usuario ha iniciado sesión, el onAuthStateChanged se encargará de
      // cargar los datos del perfil y mostrar la sección del foro.
      // NO NECESITAMOS RECARGAR LA PÁGINA NI MANIPULAR LA UI AQUÍ DIRECTAMENTE.
      // onAuthStateChanged ya tiene la lógica para esto.

    } catch (error) {
        const errorMessage = error.message;
        console.error("iniciarSesion: Error al intentar iniciar sesión:", error);
        if (error.code === 'auth/invalid-email') {
            alert("El formato del correo electrónico es inválido.");
        } else if (error.code === 'auth/user-disabled') {
            alert("Tu cuenta ha sido deshabilitada.");
        } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-login-credentials') {
            alert("Email o contraseña incorrectos.");
        } else if (error.code === 'auth/too-many-requests') {
            alert("Demasiados intentos fallidos. Inténtalo de nuevo más tarde.");
        }
        else {
            alert(`Error al iniciar sesión: ${errorMessage}`);
        }
    }
  }

  function cerrarSesion() {
    signOut(auth).then(() => {
      alert("Sesión cerrada.");
      // onAuthStateChanged se encargará de resetear la UI a login/registro
    }).catch((error) => {
      console.error("Error al cerrar sesión:", error);
    });
  }

  // ** FUNCIONES DE PUBLICACIONES Y COMENTARIOS (usan las variables y funciones globales de Firebase) **
  function crearElementoComentario(texto, autor, likes = 0, dislikes = 0) {
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `
          <strong>${autor}</strong>: ${texto}
          <div class='like-dislike'>
              <button onclick="darLikeDislike(this, 'like')">👍 <span>${likes}</span></button>
              <button onclick="darLikeDislike(this, 'dislike')">👎 <span>${dislikes}</span></button>
          </div>
          <div class='comment-input-area'>
              <textarea placeholder='Escribe una respuesta...'></textarea>
              <button onclick='comentar(this)'>Responder</button>
          </div>
          <button class="toggle-replies-button" onclick="toggleRespuestas(this)" style="display:none;">Mostrar respuestas (0)</button>
          <div class='nested-comments hidden'></div>
      `;
    return div;
  }

  async function publicar() {
    if (!window.usuarioActual) {
      alert("Debes iniciar sesión para publicar.");
      return;
    }

    const partido = document.getElementById('partido').value;
    const apuesta = document.getElementById('apuesta').value;
    const hora = document.getElementById('hora').value;
    const fecha = document.getElementById('fecha').value;
    const comentario = document.getElementById('comentario').value;

    if (!partido || !apuesta || !hora || !fecha || !comentario) {
        alert("Por favor, completa todos los campos de la publicación.");
        return;
    }

    try {
      await addDoc(collection(db, "publicaciones"), {
        autor: window.usuarioActual,
        autorUid: window.usuarioAuthId,
        partido: partido,
        apuesta: apuesta,
        hora: hora,
        fecha: fecha,
        comentario: comentario,
        likes: 0,
        dislikes: 0,
        timestamp: Date.now()
      });

      document.getElementById('partido').value = '';
      document.getElementById('apuesta').value = '';
      document.getElementById('hora').value = '';
      document.getElementById('fecha').value = '';
      document.getElementById('comentario').value = '';

    } catch (e) {
      console.error("Error al añadir publicación a Firestore: ", e);
      alert("Hubo un error al publicar. Inténtalo de nuevo.");
    }
  }

  async function comentar(btn) {
    if (!window.usuarioActual) {
      alert("Debes iniciar sesión para comentar.");
      return;
    }

    const texto = btn.previousElementSibling.value;
    if (!texto) return;

    const postElement = btn.closest('.post');
    const postId = postElement.dataset.id;

    if (!postId) {
        console.error("No se encontró el ID de la publicación para el comentario.");
        alert("No se pudo asociar el comentario a una publicación.");
        return;
    }

    try {
      await addDoc(collection(db, "publicaciones", postId, "comentarios"), {
        autor: window.usuarioActual,
        autorUid: window.usuarioAuthId,
        texto: texto,
        likes: 0,
        dislikes: 0,
        timestamp: Date.now()
      });
      btn.previousElementSibling.value = '';
    } catch (e) {
      console.error("Error al añadir comentario a Firestore: ", e);
      alert("Hubo un error al comentar. Inténtalo de nuevo.");
    }
  }

  async function darLikeDislike(btn, tipo) {
    if (!window.usuarioActual) {
      alert("Debes iniciar sesión para dar 'Me gusta' o 'No me gusta'.");
      return;
    }

    const elemento = btn.closest('.post, .comment');
    if (!elemento) return;

    const elementoId = elemento.dataset.id;
    if (!elementoId) {
      console.error("ID del elemento no encontrado para like/dislike.");
      return;
    }

    let docRefPath;
    if (elemento.classList.contains('post')) {
      docRefPath = `publicaciones/${elementoId}`;
    } else if (elemento.classList.contains('comment')) {
      const postId = elemento.closest('.post').dataset.id;
      docRefPath = `publicaciones/${postId}/comentarios/${elementoId}`;
    } else {
      console.error("Tipo de elemento desconocido para like/dislike.");
      return;
    }

    const key = `${window.usuarioAuthId}_${elementoId}`;
    const estadoPrevio = window.likes.get(key);

    let currentLikes = parseInt(elemento.querySelector('[onclick*="darLikeDislike(this, \'like\')] span').textContent);
    let currentDislikes = parseInt(elemento.querySelector('[onclick*="darLikeDislike(this, \'dislike\')] span').textContent);

    let newLikes = currentLikes;
    let newDislikes = currentDislikes;

    if (estadoPrevio === tipo) {
        window.likes.delete(key);
        if (tipo === 'like') {
            newLikes--;
        } else {
            newDislikes--;
        }
    } else {
        if (estadoPrevio === 'like') {
            newLikes--;
        } else if (estadoPrevio === 'dislike') {
            newDislikes--;
        }
        window.likes.set(key, tipo);
        if (tipo === 'like') {
            newLikes++;
        } else {
            newDislikes++;
        }
    }

    try {
        await updateDoc(doc(db, docRefPath), {
            likes: newLikes,
            dislikes: newDislikes
        });
    } catch (e) {
        console.error("Error al actualizar likes/dislikes en Firestore:", e);
        alert("Hubo un error al procesar tu like/dislike. Inténtalo de nuevo.");
        if (estadoPrevio) {
            window.likes.set(key, estadoPrevio);
        } else {
            window.likes.delete(key);
        }
    }
  }

  async function borrar(btn) {
    if (!window.usuarioActual) {
      alert("Debes iniciar sesión para borrar.");
      return;
    }

    const post = btn.closest('.post');
    const postId = post.dataset.id;

    const autorUidPublicacion = post.dataset.autorUid;

    if (autorUidPublicacion !== window.usuarioAuthId) {
      alert("Solo puedes borrar tus propias publicaciones.");
      return;
    }

    if (confirm("¿Estás seguro de que quieres borrar esta publicación y todos sus comentarios?")) {
      try {
        await deleteDoc(doc(db, "publicaciones", postId));
        console.log("Publicación borrada con éxito de Firestore.");
      } catch (e) {
        console.error("Error al borrar publicación de Firestore:", e);
        alert("Hubo un error al borrar la publicación. Inténtalo de nuevo.");
      }
    }
  }

  // ** LÓGICA PARA CARGAR Y ACTUALIZAR LA UI EN TIEMPO REAL **

  function cargarPublicaciones() {
    const publicacionesDiv = document.getElementById('publicaciones');
    publicacionesDiv.innerHTML = '';

    const q = query(collection(db, "publicaciones"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
      publicacionesDiv.innerHTML = '';
      snapshot.forEach((doc) => {
        const data = doc.data();
        const postId = doc.id;

        const div = document.createElement('div');
        div.className = 'post';
        div.dataset.id = postId;
        div.dataset.autorUid = data.autorUid;

        div.innerHTML = `
            <strong onclick="verPerfil('${data.autor}')" style="cursor:pointer;color:var(--accent-color)">${data.autor}</strong>: ${data.partido} - ${data.apuesta}<br>${data.fecha} ${data.hora}<br>${data.comentario}
            <div class='like-dislike'>
                <button onclick="darLikeDislike(this, 'like')">👍 <span>${data.likes || 0}</span></button>
                <button onclick="darLikeDislike(this, 'dislike')">👎 <span>${data.dislikes || 0}</span></button>
            </div>
            <div class='comment-section'>
                <textarea placeholder='Escribe un comentario...'></textarea>
                <button onclick='comentar(this)'>Comentar</button>
                <button class="toggle-comments-button" onclick="toggleComentariosPrincipales(this)">Mostrar comentarios (0)</button>
                <div class='main-comments hidden'></div>
            </div>
            <div class='edit-delete'>
                ${window.usuarioAuthId === data.autorUid ? `<button onclick='borrar(this)'>🗑️</button>` : ''}
            </div>
        `;
        publicacionesDiv.appendChild(div);

        cargarComentarios(postId, div.querySelector('.main-comments'), div.querySelector('.toggle-comments-button'));
      });
    }, (error) => {
      console.error("Error al cargar publicaciones:", error);
    });
  }

  function cargarComentarios(postId, commentsContainer, toggleButton) {
    const qComments = query(collection(db, "publicaciones", postId, "comentarios"), orderBy("timestamp", "asc"));

    onSnapshot(qComments, (snapshot) => {
      commentsContainer.innerHTML = '';
      snapshot.forEach((doc) => {
        const data = doc.data();
        const commentId = doc.id;

        const div = crearElementoComentario(data.texto, data.autor, data.likes || 0, data.dislikes || 0);
        div.dataset.id = commentId;
        commentsContainer.appendChild(div);
      });

      const numComments = commentsContainer.children.length;
      if (numComments > 0) {
        toggleButton.style.display = 'block';
        if (commentsContainer.classList.contains('hidden')) {
          toggleButton.textContent = `Mostrar comentarios (${numComments})`;
        } else {
          toggleButton.textContent = `Ocultar comentarios (${numComments})`;
        }
      } else {
        toggleButton.style.display = 'none';
      }
    }, (error) => {
      console.error("Error al cargar comentarios:", error);
    });
  }

  // ** FUNCIONES DE TOGGLE **
  function toggleComentariosPrincipales(btn) {
    const post = btn.closest('.post');
    const mainCommentsDiv = post.querySelector('.main-comments');
    if (mainCommentsDiv.classList.contains('hidden')) {
      mainCommentsDiv.classList.remove('hidden');
      btn.textContent = `Ocultar comentarios (${mainCommentsDiv.children.length})`;
    } else {
      mainCommentsDiv.classList.add('hidden');
      btn.textContent = `Mostrar comentarios (${mainCommentsDiv.children.length})`;
    }
  }

  function toggleRespuestas(btn) {
    const comment = btn.closest('.comment');
    const nestedCommentsDiv = comment.querySelector('.nested-comments');
    if (nestedCommentsDiv.classList.contains('hidden')) {
      nestedCommentsDiv.classList.remove('hidden');
      btn.textContent = `Mostrar respuestas (${nestedCommentsDiv.children.length})`;
    } else {
      nestedCommentsDiv.classList.add('hidden');
      btn.textContent = `Ocultar respuestas (${nestedCommentsDiv.children.length})`;
    }
  }

  // Adjuntar las funciones que necesitan ser accesibles globalmente al objeto window
  // Esto es necesario porque estas funciones son llamadas desde el HTML (onclick)
  window.toggleModo = toggleModo;
  window.mostrarSeccion = mostrarSeccion;
  window.mostrarLoginScreen = mostrarLoginScreen;
  window.mostrarRegistroScreen = mostrarRegistroScreen;
  window.verPerfil = verPerfil;
  window.mostrarNotificaciones = mostrarNotificaciones;
  window.buscar = buscar;
  window.guardarDescripcion = guardarDescripcion;
  window.toggleSeguir = toggleSeguir;
  window.registrarse = registrarse;
  window.iniciarSesion = iniciarSesion;
  window.cerrarSesion = cerrarSesion;
  window.publicar = publicar;
  window.comentar = comentar;
  window.darLikeDislike = darLikeDislike;
  window.borrar = borrar;
  window.toggleComentariosPrincipales = toggleComentariosPrincipales;
  window.toggleRespuestas = toggleRespuestas;
  window.cargarPublicaciones = cargarPublicaciones; 

</script>
